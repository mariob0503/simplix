<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lift&Learn Gesture Testing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Global styling using a Simplix-inspired palette */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #121212;  /* Dark background */
      font-family: Arial, sans-serif;
      overflow: hidden;
      color: #ffffff;
    }
    /* Flag styling at the top */
    #flag {
      position: absolute;
      top: 0;
      width: 100%;
      text-align: center;
      padding: 10px 0;
      font-size: 1.43rem;
      line-height: 1.3;
      z-index: 10;
      pointer-events: none;
    }
    /* Accent color classes */
    .blue { 
      color: #0091EA; 
    }
    .blue-bold { 
      color: #0091EA; 
      font-weight: bold; 
    }
    /* Big and bold styling for Lift&Learn */
    .big-bold {
      font-size: 2.86rem;
      font-weight: bold;
    }
    /* Center container for sensor readings / success screens */
    #centerDisplay {
      position: absolute;
      top: 60%; /* Moved down so it doesn‚Äôt overlap the flag */
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 20;
      width: 90%;
    }
    /* Default display inside the center area */
    #sensorReadings {
      font-size: 1rem;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    #message {
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    #pointsCounter {
      font-size: 1.5rem;
      color: #FFD700; /* Gold for PowerPoints */
      margin-bottom: 10px;
    }
    /* Shake progress bar container */
    #shakeProgressContainer {
      width: 80%;
      height: 20px;
      background-color: #555;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    /* Shake progress bar fill */
    #shakeProgress {
      width: 0%;
      height: 100%;
      background-color: #FFD700;
    }
    /* Buttons container fixed at the bottom */
    .buttons {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      z-index: 30;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 1.1rem;
      background-color: #0091EA; /* Simplix blue accent */
      color: #ffffff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:active {
      transform: scale(0.98);
    }
    /* (Optional) Big bubble style for tilt success */
    .bubble {
      position: absolute;
      background: rgba(0, 145, 234, 0.7);
      border-radius: 50%;
      opacity: 0;
      animation: rise 2s ease-out forwards;
    }
    @keyframes rise {
      0% {
        transform: translateY(0) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translateY(-150px) scale(1);
        opacity: 0;
      }
    }
    /* Arrow styling and animation for swipe prompt */
    #arrow {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 3rem;
      opacity: 0;
      display: none;
      z-index: 5;
    }
    .animate-arrow {
      animation: swipeArrow 1.5s ease-out forwards;
    }
    @keyframes swipeArrow {
      0% {
        bottom: 140px;
        opacity: 1;
      }
      100% {
        bottom: 90%;
        opacity: 0;
      }
    }
    /* CSS animation for shaking protein bottle */
    @keyframes shake {
      0% { transform: translate(0px, 0px) rotate(0deg); }
      25% { transform: translate(2px, -2px) rotate(-5deg); }
      50% { transform: translate(-2px, 2px) rotate(5deg); }
      75% { transform: translate(2px, -2px) rotate(-5deg); }
      100% { transform: translate(0px, 0px) rotate(0deg); }
    }
  </style>
</head>
<body>
  <!-- Fancy Flag at the top -->
  <div id="flag">
    <div>Welcome to</div>
    <div class="big-bold">
      <span class="blue">Lift</span>&Learn
    </div>
    <div>your <strong><span class="blue">Simplix</span> Gym Reward System</strong></div>
    <div>collect your <strong><span class="blue-bold">Power</span>Points</strong></div>
    <div>and get great discounts on Supplements</div>
  </div>

  <!-- Center container (initially shows sensor readings) -->
  <div id="centerDisplay">
    <div id="sensorReadings">Waiting for sensor data...</div>
    <div id="message"></div>
    <div id="pointsCounter">PowerPoints: 0</div>
  </div>

  <!-- Buttons container fixed at the bottom -->
  <div class="buttons">
    <button id="shakeButton">Shake</button>
    <button id="tiltButton">Tilt</button>
    <button id="swipeButton">Swipe</button>
    <button id="resetButton">Reset</button>
  </div>

  <!-- Arrow element for swipe prompt -->
  <div id="arrow">‚¨ÜÔ∏è</div>

  <script>
    // Declare these with 'let' so we can reassign on reset.
    let sensorReadingsDiv = document.getElementById('sensorReadings');
    let messageDiv = document.getElementById('message');
    let pointsCounterDiv = document.getElementById('pointsCounter');
    const centerDisplay = document.getElementById('centerDisplay');
    const arrowDiv = document.getElementById('arrow');

    /* --- Global sensor data variables --- */
    let devicemotionText = '';
    let deviceOrientationText = '';
    let sensorListenersAdded = false;

    // Throttle sensor updates: update at most once every 500ms.
    let lastSensorUpdate = 0;
    function updateSensorReadings() {
      const now = Date.now();
      if (now - lastSensorUpdate < 500) return;
      lastSensorUpdate = now;
      if (sensorReadingsDiv) {
        sensorReadingsDiv.innerHTML = devicemotionText + '<br>' + deviceOrientationText;
      }
    }

    // Utility: Format sensor value so that only full (rounded) digits are shown.
    function formatValue(val) {
      if (val === null) return 0;
      let rounded = Math.round(val);
      return Math.abs(rounded) < 1 ? 0 : rounded;
    }

    // Points variables
    let totalPoints = 0;
    function updatePointsCounter() {
      if (pointsCounterDiv) {
        pointsCounterDiv.textContent = 'PowerPoints: ' + totalPoints;
      }
    }
    // Award points.
    function addPoints(pts) {
      totalPoints += pts;
      updatePointsCounter();
    }

    // --- Sensor Reading Handlers ---
    // "Strength Metrics" (acceleration/rotation)
    function sensorDataUpdate(event) {
      let accIG = event.accelerationIncludingGravity;
      let acc = event.acceleration;
      let rotation = event.rotationRate;
      devicemotionText = "<strong>Strength Metrics:</strong><br>";
      if (accIG) {
        devicemotionText += `Acc IG: x=${formatValue(accIG.x)}, y=${formatValue(accIG.y)}, z=${formatValue(accIG.z)}.<br>`;
      }
      if (acc) {
        devicemotionText += `Acc: x=${formatValue(acc.x)}, y=${formatValue(acc.y)}, z=${formatValue(acc.z)}.<br>`;
      }
      if (rotation) {
        devicemotionText += `Rotation: alpha=${formatValue(rotation.alpha)}, beta=${formatValue(rotation.beta)}, gamma=${formatValue(rotation.gamma)}.`;
      }
      updateSensorReadings();
    }
    // "Form & Balance" (orientation)
    function sensorOrientationUpdate(event) {
      deviceOrientationText = "<strong>Form &amp; Balance:</strong><br>";
      deviceOrientationText += `Alpha=${formatValue(event.alpha)}, `;
      deviceOrientationText += `Beta=${formatValue(event.beta)}, `;
      deviceOrientationText += `Gamma=${formatValue(event.gamma)}.`;
      updateSensorReadings();
    }

    /* --- Success Screen Display ---
         When an activity is complete, update the centerDisplay
         to show a persistent success message/image along with the current PowerPoints balance.
    */
    function showSuccessScreen(contentHTML) {
      centerDisplay.innerHTML = contentHTML +
        '<div style="font-size:1.5rem; color:#FFD700; margin-top:10px;">PowerPoints: ' + totalPoints + '</div>';
    }

    // Shake success: Show a shaking Protein Bottle for three seconds.
    function showShakeSuccessScreen() {
      const contentHTML = "<h1 style='font-size:3rem; margin-bottom:20px;'>PowerPoints taken!</h1>" +
        "<div id='shakeAnimation' style='font-size:4rem; text-align:center; padding:20px;'>ü•§</div>";
      showSuccessScreen(contentHTML);
      const shakeElement = document.getElementById('shakeAnimation');
      // Apply the shaking animation to simulate a protein bottle being shaken.
      shakeElement.style.animation = "shake 0.5s infinite";
      // Remove the animation after 3 seconds.
      setTimeout(() => {
        shakeElement.style.animation = "";
      }, 3000);
    }
    // Tilt success: Big balloons.
    function showTiltSuccessScreen() {
      const contentHTML = "<h1 style='font-size:3rem; margin-bottom:20px;'>PowerPoints taken!</h1>" +
        "<div style='font-size:4rem; text-align:center; padding:20px;'>üéàüéàüéà<br>Tilt Mastery Achieved!</div>";
      showSuccessScreen(contentHTML);
    }
    // Swipe success: Big blue arrows.
    function showSwipeSuccessScreen() {
      const contentHTML = "<h1 style='font-size:3rem; margin-bottom:20px;'>PowerPoints taken!</h1>" +
        "<div style='font-size:4rem; text-align:center; padding:20px;'>‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è<br>Speedy Swipe Success!</div>";
      showSuccessScreen(contentHTML);
    }

    /* --- Gesture Test Code --- */

    /* 1. Shake */
    const shakeButton = document.getElementById('shakeButton');
    let shakeDetected = false;
    let shakeMotionListener = null;
    let shakeTimeout = null;
    let shakeStartTime = null; // For tracking continuous shaking time
    const shakeAccelerationThreshold = 12; // m/s¬≤
    const shakeListeningTime = 10000; // 10 seconds
    const requiredShakeDuration = 3000; // 3 seconds (3000ms)

    function handleShakeMotion(event) {
      let acc = event.acceleration;
      if (!acc || (acc.x === null && acc.y === null && acc.z === null)) {
        acc = event.accelerationIncludingGravity;
      }
      const x = acc.x !== null ? formatValue(acc.x) : 0;
      const y = acc.y !== null ? formatValue(acc.y) : 0;
      const z = acc.z !== null ? formatValue(acc.z) : 0;
      const magnitude = Math.sqrt(x * x + y * y + z * z);
      if (magnitude > shakeAccelerationThreshold) {
        // Start (or continue) counting the shaking duration.
        if (shakeStartTime === null) {
          shakeStartTime = Date.now();
        }
        let elapsed = Date.now() - shakeStartTime;
        // Update progress bar (if exists).
        let progressElem = document.getElementById('shakeProgress');
        if (progressElem) {
          let percent = Math.min(100, (elapsed / requiredShakeDuration) * 100);
          progressElem.style.width = percent + '%';
        }
        // If shaking has been sustained for 3 seconds, trigger success.
        if (elapsed >= requiredShakeDuration && !shakeDetected) {
          shakeDetected = true;
          if (shakeTimeout) clearTimeout(shakeTimeout);
          stopShakeListening();
          addPoints(10);
          showShakeSuccessScreen();
        }
      } else {
        // If the acceleration falls below threshold, reset the timer and progress bar.
        shakeStartTime = null;
        let progressElem = document.getElementById('shakeProgress');
        if (progressElem) {
          progressElem.style.width = '0%';
        }
      }
    }

    function stopShakeListening() {
      if (shakeMotionListener) {
        window.removeEventListener('devicemotion', shakeMotionListener);
        shakeMotionListener = null;
      }
      if (shakeTimeout) {
        clearTimeout(shakeTimeout);
        shakeTimeout = null;
      }
    }

    function startShakeTest() {
      shakeDetected = false;
      shakeStartTime = null;
      // Update the center display to include a progress bar.
      centerDisplay.innerHTML = 
        '<div id="sensorReadings">Waiting for sensor data...</div>' +
        '<div id="message">Shake: Shake your phone like you‚Äôre lifting heavy weights!</div>' +
        '<div id="pointsCounter">PowerPoints: ' + totalPoints + '</div>' +
        '<div id="shakeProgressContainer">' +
          '<div id="shakeProgress"></div>' +
        '</div>';
      sensorReadingsDiv = document.getElementById('sensorReadings');
      messageDiv = document.getElementById('message');
      pointsCounterDiv = document.getElementById('pointsCounter');
      // Add sensor listeners if not already added.
      if (!sensorListenersAdded) {
        window.addEventListener('devicemotion', sensorDataUpdate);
        window.addEventListener('deviceorientation', sensorOrientationUpdate);
        sensorListenersAdded = true;
      }
      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              shakeMotionListener = handleShakeMotion;
              window.addEventListener('devicemotion', shakeMotionListener);
            } else {
              messageDiv.textContent = 'Permission not granted for motion sensors.';
            }
          })
          .catch(err => {
            console.error(err);
            messageDiv.textContent = 'Error requesting motion sensor permission.';
          });
      } else {
        shakeMotionListener = handleShakeMotion;
        window.addEventListener('devicemotion', shakeMotionListener);
      }
      // Set a timeout to end the shake test after a fixed period.
      shakeTimeout = setTimeout(() => {
        stopShakeListening();
        if (!shakeDetected) {
          // If shaking was initiated but did not reach 3 seconds, show "Shake harder!".
          if (shakeStartTime !== null && (Date.now() - shakeStartTime < requiredShakeDuration)) {
            messageDiv.textContent = 'Shake harder!';
          } else {
            messageDiv.textContent = 'No power shake detected. Try again!';
          }
        }
      }, shakeListeningTime);
    }
    shakeButton.addEventListener('click', startShakeTest);

    /* 2. Tilt */
    const tiltButton = document.getElementById('tiltButton');
    let tiltBaseline = null;
    // Tilt triggers when the beta angle changes by 90¬∞ from the starting value.
    function handleTilt(event) {
      const currentBeta = event.beta !== null ? formatValue(event.beta) : 0;
      if (tiltBaseline === null) {
        tiltBaseline = currentBeta;
        messageDiv.textContent = "Tilt: Start tilting ‚Äì change your angle by 90¬∞!";
      } else if (Math.abs(currentBeta - tiltBaseline) >= 90) {
        addPoints(15);
        showTiltSuccessScreen();
        window.removeEventListener('deviceorientation', handleTilt);
        tiltBaseline = null;
      }
    }
    function startTiltTest() {
      tiltBaseline = null;
      messageDiv.textContent = "Tilt: Tilt your phone so your beta angle changes by 90¬∞!";
      window.addEventListener('deviceorientation', handleTilt);
    }
    tiltButton.addEventListener('click', startTiltTest);

    /* 3. Swipe */
    const swipeButton = document.getElementById('swipeButton');
    let touchStartY = null;
    let touchEndY = null;
    function handleTouchStart(e) {
      touchStartY = e.changedTouches[0].screenY;
    }
    function handleTouchEnd(e) {
      touchEndY = e.changedTouches[0].screenY;
      const deltaY = touchStartY - touchEndY;
      if (deltaY > 50) {
        addPoints(20);
        showSwipeSuccessScreen();
      } else {
        messageDiv.textContent = 'Swipe too short. Push harder!';
      }
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    }
    function startSwipeTest() {
      messageDiv.textContent = "Swipe: Swipe up like you're running up stairs for a cardio boost!";
      arrowDiv.style.display = 'block';
      arrowDiv.classList.add('animate-arrow');
      arrowDiv.addEventListener('animationend', () => {
        arrowDiv.classList.remove('animate-arrow');
      }, {once: true});
      document.addEventListener('touchstart', handleTouchStart);
      document.addEventListener('touchend', handleTouchEnd);
    }
    swipeButton.addEventListener('click', startSwipeTest);

    /* 4. Reset */
    const resetButton = document.getElementById('resetButton');
    function resetDisplay() {
      // Restore the default center display with sensor readings and messages.
      centerDisplay.innerHTML =
        '<div id="sensorReadings">Waiting for sensor data...</div>' +
        '<div id="message"></div>' +
        '<div id="pointsCounter">PowerPoints: ' + totalPoints + '</div>';
      // Reassign the elements.
      sensorReadingsDiv = document.getElementById('sensorReadings');
      messageDiv = document.getElementById('message');
      pointsCounterDiv = document.getElementById('pointsCounter');
    }
    resetButton.addEventListener('click', () => {
      messageDiv.textContent = "Ready for the next round of gym action!";
      arrowDiv.style.display = 'none';
      stopShakeListening();
      window.removeEventListener('deviceorientation', handleTilt);
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
      resetDisplay();
    });
  </script>
</body>
</html>
